name: Build and update flake.lock

on: [push, repository_dispatch, workflow_dispatch]

jobs:
  matrix:
    name: Generate build matrix
    runs-on: ubuntu-latest

    outputs:
      packages: ${{ steps.matrix.outputs.packages }}

    steps:
      - uses: actions/checkout@v3

      - uses: cachix/install-nix-action@v18

      - id: matrix
        run: ./build_matrix.py | tee $GITHUB_STEP_SUMMARY

  build:
    name: ${{ matrix.package }}
    runs-on: ubuntu-latest
    needs: matrix

    if: needs.matrix.outputs.packages != '[]'

    strategy:
      matrix:
        package: ${{ fromJson(needs.matrix.outputs.packages) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v3

      - uses: cachix/install-nix-action@v18

      - uses: cachix/cachix-action@v11
        with:
          name: internetunexplorer
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          pushFilter: '-source$'

      - run: nix build .#${{ matrix.package }} --recreate-lock-file --print-build-logs

  update-flake-lock:
    name: Update flake.lock
    runs-on: ubuntu-latest
    needs: build

    # See: https://github.com/actions/runner/issues/491
    if: |
      always()
      && (needs.build.result == 'success' || needs.build.result == 'skipped')
      && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v3

      - uses: cachix/install-nix-action@v18

      - run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - run: nix flake update --commit-lock-file

      - run: git push
